function [monitor] = SimReadMonitor(fileName)% [monitor] = SimReadMonitor(fileName)%% Reads a monitor description from the file and fill in the structure.% And fills some gaps for PsychoToolbox use ...%% Passed filename can be a file handle, to allow reading of% monitor information from inside image file.%% This code should be patched up when we fix up gamma fitting% code in the Psychophysics Toolbox.%% 6/10/98  pxl  Wrote it.% 7/6/98   dhb  Minor tidying. % 10/29/98 dhb  Replace isEqualN by strncmp.% 11/04/98 pxl  Changed it to new (more general) monitor type.% 1/13/99  dhb  Changed to be closer to image, camera readers.% 1/19/99  dhb  Allow passed arg to be a file handle.%          dhb  Eliminate previously required header.% 3/1/99   dhb  Fix gamma splining to eliminate NaN from ends.% Copyright (c) 1999 David Brainard and Philippe Longere.   All rights reserved.% Argument checkif (nargin < 1)	  error('ReadMonitor: requires a filename');end% Open the fileif (isstr(fileName))file = fopen(fileName,'r');	if (isequal(file,-1))		   error(sprintf('ReadMonitor: file %s not found.\n',fileName));	endelse	file = fileName;end% Monitor file is sensible, everything is stored as custom data.monitor = SimReadCustom(file,[]);% Close the fileif (isstr(fileName))	fclose(file);end% Check that we got all mandatory fields.listOfRequired = strvcat('manufacturer','name','nDevices','wavelengthSampling','emissionSpectra','height','width');missing = SimCheckRequiredFields(monitor,listOfRequired);if (~isempty(missing))	error(sprintf('ReadMonitor: a mandatory field (%s) is not present',missing));end% Spline gamma measurements for use in calibration.% This should be redone to match code in Psychophysics% Toolbox calibration routine.  Also note this code is% specific to an 8-bit output device with three primaries.if (size(monitor.rawGammaTable,2) ~= 3)  error('ReadMonitor assumes three device primaries')endif (max(monitor.rawGammaInput) ~= 255)  fprintf(['Gamma Input different from 255, discarding, and replacing ' ...	  'by linear mapping\n']);  monitor.gammaInput = [0:255];  monitor.gammaTable =  [[0:1/255:1]' [0:1/255:1]' [0:1/255:1]'];else  monitor.gammaInput = [0:255];  if (size(monitor.rawGammaInput,1)<256)    monitor.gammaTable = ...	MakeMonotonic(interp1([0 ; monitor.rawGammaInput],...			      [[0 0 0] ; monitor.rawGammaTable],...			      monitor.gammaInput));  else    monitor.gammaTable = ...	MakeMonotonic(interp1([monitor.rawGammaInput],...			      [monitor.rawGammaTable],...			      monitor.gammaInput));  endendmonitor.nPrimaryBases = 1;imag(:,:,1) = ones(256);imag(:,:,2) = zeros(256);imag(:,:,3) = zeros(256);% Data for the psychoToolbox to work, these are% just different names.  Probably we should settle% on a single naming convention.start = monitor.wavelengthSampling.start;step = monitor.wavelengthSampling.step;numberSamples = monitor.wavelengthSampling.numberSamples;monitor.P_device = monitor.emissionSpectra;monitor = rmfield(monitor,'emissionSpectra');monitor.S_device = [start step numberSamples];monitor.T_device = eye(numberSamples);monitor.T_ambient = monitor.T_device;% These are the ambient illumination measurement% If they don't exist, let's assume they are zero.if (~isfield(monitor,'ambientSpectrum'))  monitor.P_ambient = zeros(numberSamples,1);  monitor.S_ambient = monitor.S_device;else	monitor.P_ambient = monitor.ambientSpectrum;	monitor.S_ambient = monitor.S_device;	if (length(monitor.P_ambient) ~= monitor.S_device(3))		error('Size mismatch between phosphor and ambient spectra');	end	monitor = rmfield(monitor,'ambientSpectrum');end